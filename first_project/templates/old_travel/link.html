{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">

    <h3 class="mb-3">共有リンクの作成</h3>

    <form method="post">
        {% csrf_token %}

        <!-- 権限設定 -->
        <div class="mb-4">
            <label class="form-label fw-bold">権限の設定</label>
            {{ form.permission_type }}
            <div class="form-text">
                ・閲覧のみ：他の人は見るだけで編集できません<br>
                ・編集可能：他の人も内容を変更できます
            </div>
        </div>

        <!-- 有効期限設定 -->
        <div class="mb-4">
            <label class="form-label fw-bold">有効期限の設定</label>
            {{ form.expiration_type }}

            <div class="mt-2">
                <strong>有効期限：</strong>
                <span id="expiration_display">選択してください</span>
            </div>

            <!-- ユーザー入力用 -->
            <div id="date_input_wrapper" class="mt-2" style="display:none;">
                {{ form.expiration_date }}
            </div>

            <!-- 旅行終了日（JS用） -->
            <input type="hidden" id="trip_end_date" value="{{ template.end_date }}">
        </div>

        <button type="submit" class="btn btn-primary w-100">リンクを発行</button>
    </form>

    <div class="mt-3 text-center">
        <a href="{% url 'app:travel_detail' template.id %}" class="text-secondary">キャンセル（旅行詳細へ戻る）</a>
    </div>

</div>

<script>
function updateExpiration() {
    const type = document.querySelector('input[name="expiration_type"]:checked')?.value;
    const display = document.getElementById("expiration_display");
    const dateInputWrapper = document.getElementById("date_input_wrapper");

    if (!type) return;

    let date = null;

    if (type === "0") { // ONE_MONTH
        dateInputWrapper.style.display = "none";
        date = new Date();
        date.setMonth(date.getMonth() + 1);

    } else if (type === "1") { // AFTER_TRIP
        dateInputWrapper.style.display = "none";
        date = new Date(document.getElementById("trip_end_date").value);
        date.setDate(date.getDate() + 1);

    } else { // USER_INPUT
        dateInputWrapper.style.display = "block";
        display.textContent = "日付を入力してください";
        return;
    }

    display.textContent = `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日まで`;
}

document.querySelectorAll('input[name="expiration_type"]').forEach(r => {
    r.addEventListener("change", updateExpiration);
});
</script>

{% endblock %}
