{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'tabipre/css/old_template/template_manage.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">

    <h2 class="mb-3">{{ template.travel_info.travel_title }}</h2>

    <!-- 親フォーム：保存・削除・チェック更新・分類追加 -->
    <form method="POST">
        {% csrf_token %}

        <!-- ⭐⭐⭐ ここが最重要：hidden input を追加 ⭐⭐⭐ -->
        {% for category in categories %}
            {% for item in category.travelitem_set.all %}
                <input type="hidden" name="hidden_checked_{{ item.id }}" value="{{ item.item_checked }}">
                <input type="hidden" name="hidden_name_{{ item.id }}" value="{{ item.item_name }}">
            {% endfor %}
        {% endfor %}
        <!-- ⭐⭐⭐ ここまで必須 ⭐⭐⭐ -->

        {% for category in categories %}
        <div class="card mb-3 shadow-sm">

            <div class="card-header text-white d-flex justify-content-between align-items-center"
                 style="background-color: {{ category.get_category_color_display }};">

                <div class="d-flex align-items-center"
                     data-bs-toggle="collapse"
                     data-bs-target="#cat{{ category.id }}"
                     style="cursor: pointer;">

                    <strong>{{ category.category_name }}</strong>

                    <span class="badge bg-light text-dark ms-2">
                        {{ category.checked_count }} / {{ category.total_count }}
                    </span>

                    <span class="ms-2">▼</span>
                </div>

                <!-- 分類削除 -->
                <button type="submit"
                        name="delete_category"
                        value="{{ category.id }}"
                        class="btn btn-link fs-4 p-0"
                        style="text-decoration: none; color: white;"
                        onclick="event.stopPropagation();">
                    ×
                </button>
            </div>

            <ul id="cat{{ category.id }}" class="list-group list-group-flush collapse show">

                {% for item in category.travelitem_set.all %}
                <li class="list-group-item">
                    <div class="d-flex align-items-center w-100">

                        <!-- チェック -->
                        <input type="checkbox"
                               name="item_checked_{{ item.id }}"
                               class="form-check-input me-3"
                               {% if item.item_checked %}checked{% endif %}>

                        <!-- 名前編集 -->
                        <input type="text"
                               name="rename_{{ item.id }}"
                               value="{{ item.item_name }}"
                               class="form-control">

                        <!-- 削除 -->
                        <button type="submit"
                                name="delete_item"
                                value="{{ item.id }}"
                                class="delete-x ms-3"
                                onclick="event.stopPropagation();">
                            ×
                        </button>

                    </div>
                </li>
                {% empty %}
                <li class="list-group-item text-muted">項目がありません</li>
                {% endfor %}

            </ul>

        </div>
        {% endfor %}

        <button type="submit"
                name="go_add"
                value="1"
                class="btn custom-add-btn mb-3 w-100 mt-3">
         ＋分類・項目の追加
        </button>


        <!-- ⭐ 保存ボタン -->
        <button type="submit" name="save_changes" class="btn btn-primary w-100 mt-3">
            保存
        </button>

    </form>

</div>
{% endblock %}